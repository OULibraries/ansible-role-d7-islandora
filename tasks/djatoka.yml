---
- name: Download djatoka from Sourceforge
  get_url:
    url: "https://sourceforge.net/projects/djatoka/files/djatoka/1.1/adore-djatoka-1.1.tar.gz"
    timeout: 90
    dest: "/tmp/downloads/adore-djatoka-1.1.tar.gz"
    
- name: UnArchive djatoka
  unarchive: 
    src: "/tmp/downloads/adore-djatoka-1.1.tar.gz"
    dest: "/tmp/downloads"
    remote_src: yes
    
- name: Create parent for djatoka installation (/opt/adore)
  file:
    path: /opt/adore/
    state: directory
    owner: tomcat
    group: tomcat
    mode: 0755
    
- name: Install djatoka files
  shell: >
    cp --recursive -v /tmp/downloads/adore-djatoka-1.1 "/opt/adore/"

- name: Build link for /opt/adore/djatoka
  file:
    state: link
    force: true
    src: /opt/adore/adore-djatoka-1.1
    dest: /opt/adore/djatoka

- name: Copy Djatoka war to tomcat/webapps
  copy:
    src: "/opt/adore/djatoka/dist/adore-djatoka.war"
    dest: "/usr/share/tomcat/webapps/adore-djatoka.war"
    remote_src: true 

- name: Configure Tomcat environment
  template:
    src: tomcat.conf.j2
    dest: /etc/tomcat/tomcat.conf
    owner: tomcat
    group: tomcat

- name: Restart Tomcat to deploy Djatoka
  service:
    name: "tomcat"
    state: "restarted"

- name: Pause while Tomcat restarts
  wait_for:
    port: 8080
    delay: 10

- name: Configure log4j for Djatoka
  copy:
    src: djatoka-log4j.properties
    dest: /usr/share/tomcat/webapps/adore-djatoka/WEB-INF/classes/log4j.properties
    owner: tomcat
    group: tomcat

- name: Configure Kakadu libraries
  lineinfile:
    dest: /etc/ld.so.conf.d/kdu_libs.conf
    insertafter: EOF
    create: yes
    line:  /opt/adore/djatoka/lib/Linux-x86-64
      
# - name: Accommodating viewing restrictions for djatoka
#   template:
#     src: "web.xml.j2"
#     dest: "/usr/share/tomcat/webapps/fedora/WEB-INF/web.xml"
#     owner: "tomcat"
#     group: "tomcat"
    
# - name: Modify Drupal filter configuration
#   blockinfile:
#     dest: "/usr/local/fedora/server/config/filter-drupal.xml"
#     block: |
#       <service_requests>
#         <service name="djatoka">
#         <allowed_ips>local</allowed_ips>
#         <allowed_uri_pattern>^.*/(JP2\|TEI)$</allowed_uri_pattern>
#         <roles>administrator fedora_anonymous</roles>
#         </service>
#       </service_requests>
    
