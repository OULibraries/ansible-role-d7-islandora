---

- name: Download djatoka from Sourceforge
  get_url:
    url: "https://sourceforge.net/projects/djatoka/files/djatoka/1.1/adore-djatoka-1.1.tar.gz"
    timeout: 90
    dest: "/tmp/downloads/adore-djatoka-1.1.tar.gz"
    
- name: UnArchive djatoka
  unarchive: 
    src: "/tmp/downloads/adore-djatoka-1.1.tar.gz"
    dest: "/tmp/downloads"
    remote_src: yes
    
- name: Install djatoka installation directory
  tags: djatoka
  file:
    path: /opt/djatoka/
    state: directory
    owner: tomcat
    group: tomcat
    mode: 0755
    
- name: Copy solr example files to the new directory
  tags: djatoka
  shell: >
    cp --recursive -v /tmp/downloads/adore-djatoka-1.1 "/opt/djatoka"

- name: Modify the Tomcat startup.sh script
  blockinfile:
    dest: /usr/share/tomcat/bin/startup.sh
    insertafter: EOF
    block: |
      . /opt/djatoka/bin/env.sh
      export JAVA_OPTS
      echo $JAVA_OPTS
      exec "$PRGDIR"/"$EXECUTABLE" start "$@"
      
- name: Backup original djatoka env.sh
  copy:
    src: "/opt/djatoka/bin/env.sh"
    dest: "/opt/djatoka/bin/env.sh.bak"
    remote_src: true
      
- name: Configure djatoka env.sh
  template:
    src: "env.sh.j2"
    dest: "/opt/djatoka/bin/env.sh"
    owner: "tomcat"
    group: "tomcat"
    
- name: Set up Djatoka log files
  lineinfile:
      dest: /opt/djatoka/bin/log4j.properties
      insertafter: EOF
      line: log.dir=/usr/local/fedora/server/logs/
      
- name: Accommodating viewing restrictions for djatoka
  template:
    src: "web.xml.j2"
    dest: "/usr/share/tomcat/webapps/fedora/WEB-INF/web.xml"
    owner: "tomcat"
    group: "tomcat"
    
- name: Modify Drupal filter configuration
  blockinfile:
    dest: "/usr/local/fedora/server/config/filter-drupal.xml"
    block: |
      <service_requests>
        <service name="djatoka">
        <allowed_ips>local</allowed_ips>
        <allowed_uri_pattern>^.*/(JP2\|TEI)$</allowed_uri_pattern>
        <roles>administrator fedora_anonymous</roles>
        </service>
      </service_requests>
    
- name: Restart tomcat for djatoka
  command: "{{ item }}"
  with_items:
    - /usr/share/tomcat/bin/shutdown.sh
    - /usr/share/tomcat/bin/startup.sh